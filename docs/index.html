<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Demand Forecast Lab ‚Äî –ü—Ä–æ–≥–Ω–æ–∑ –∏ –º–µ—Ç—Ä–∏–∫–∏</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/uplot/dist/uPlot.min.css">
  <style>
    :root {
      --gold: #d4af37;
      --paper: #ffffff;
      --ink: #222;
      --border: #eee;
    }
    body {
      font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, sans-serif;
      background: var(--paper);
      color: var(--ink);
      margin: 24px;
    }
    header {
      display:flex;justify-content:space-between;align-items:center;
      border-bottom:2px solid var(--gold);padding-bottom:8px;margin-bottom:20px;
    }
    h1 {margin:0;color:var(--ink);}
    .card {
      border:1px solid var(--border);
      border-radius:16px;
      padding:16px;
      margin-bottom:24px;
      box-shadow:0 2px 8px rgba(0,0,0,.05);
    }
    .controls {display:flex;gap:12px;flex-wrap:wrap;margin-top:10px;}
    select,button {
      border:1px solid var(--border);
      border-radius:10px;
      padding:8px 12px;
    }
    .kpi {display:flex;flex-wrap:wrap;gap:12px;margin-top:12px;}
    .kpi div {
      background:#fafafa;
      border:1px solid #eee;
      border-radius:12px;
      padding:10px 14px;
      min-width:120px;
    }
    footer {
      margin-top:32px;
      font-size:14px;
      color:#666;
      border-top:1px solid var(--border);
      padding-top:8px;
    }
  </style>
</head>
<body>
  <header>
    <h1>Demand Forecast Lab</h1>
    <nav><a href="./data/catalog.json" target="_blank">catalog.json</a></nav>
  </header>

  <div class="card">
    <h3>üìà –ü—Ä–æ–≥–Ω–æ–∑ –ø—Ä–æ–¥–∞–∂</h3>
    <div id="chart" style="height:360px"></div>
    <div class="controls">
      <label>–ü–∞—Ä–∞:</label>
      <select id="pairSel"></select>
      <label>–ú–æ–¥–µ–ª—å:</label>
      <select id="modelSel">
        <option value="yhat_ses">Holt‚ÄìWinters (SES)</option>
        <option value="yhat_arima">ARIMA(1,1,1)</option>
      </select>
      <button id="download">–°–∫–∞—á–∞—Ç—å JSON</button>
    </div>
  </div>

  <div class="card">
    <h3>üìä –ú–µ—Ç—Ä–∏–∫–∏ —Ç–æ—á–Ω–æ—Å—Ç–∏ (holdout)</h3>
    <div id="kpis" class="kpi"></div>
  </div>

  <footer>
    <p>–ê—Ä—Ç–µ—Ñ–∞–∫—Ç—ã –≥–µ–Ω–µ—Ä–∏—Ä—É—é—Ç—Å—è GitHub Actions –∏–∑ <code>data/time_series.csv</code> ‚Üí <code>docs/data/*.json</code>.</p>
  </footer>

  <script src="https://cdn.jsdelivr.net/npm/uplot/dist/uPlot.iife.min.js"></script>
  <script>
    async function loadJSON(p){const r=await fetch(p,{cache:"no-store"});return r.json();}
    const fmt = d => new Date(d).getTime()/1000;
    let plot, catalog=[], currentKey, model="yhat_ses";

    async function init(){
      try{
        catalog = await loadJSON("./data/catalog.json");
      }catch(e){
        document.getElementById("chart").innerHTML="<p>–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö: –∑–∞–ø—É—Å—Ç–∏—Ç–µ workflow Build artifacts.</p>";
        return;
      }
      const sel=document.getElementById("pairSel");
      catalog.forEach(c=>{
        const opt=document.createElement("option");
        opt.value=c.key;
        opt.textContent=`${c.client_id} √ó ${c.product_id}`;
        sel.appendChild(opt);
      });
      currentKey=catalog[0].key;
      await loadPair(currentKey);
      sel.addEventListener("change",async e=>{
        currentKey=e.target.value;
        await loadPair(currentKey);
      });
      document.getElementById("modelSel").addEventListener("change",e=>{
        model=e.target.value;
        draw(window.currentFC,model);
      });
      document.getElementById("download").addEventListener("click",()=>{
        if(!window.currentFC)return;
        const blob=new Blob([JSON.stringify(window.currentFC,null,2)],{type:"application/json"});
        const a=document.createElement("a");
        a.href=URL.createObjectURL(blob);
        a.download=`forecast_${currentKey}.json`;
        a.click();
      });
    }

    async function loadPair(key){
      const fc=await loadJSON(`./data/forecast_${key}.json`);
      const met=await loadJSON(`./data/metrics_${key}.json`);
      window.currentFC=fc;
      renderKPIs(met);
      draw(fc,model);
    }

    function draw(rows,field){
      const x=rows.map(r=>fmt(r.ds));
      const y=rows.map(r=>+r[field]);
      const data=[x,y];
      const opts={
        title:`Forecast ‚Äî ${field==="yhat_ses"?"SES":"ARIMA"}`,
        width:document.getElementById("chart").clientWidth,
        height:360,
        series:[
          {label:"Date"},
          {label:"Forecast",stroke:"gold"}
        ],
        axes:[
          {values:(u,ticks)=>ticks.map(t=>new Date(t*1000).toISOString().slice(0,7))},
          {}
        ]
      };
      if(plot) plot.destroy();
      plot=new uPlot(opts,data,document.getElementById("chart"));
    }

    function renderKPIs(met){
      const box=document.getElementById("kpis");
      box.innerHTML="";
      met.forEach(row=>{
        const div=document.createElement("div");
        div.innerHTML=`<b>${row.metric}</b><br>SES: ${row.SES.toFixed(2)}<br>ARIMA: ${row.ARIMA.toFixed(2)}`;
        box.appendChild(div);
      });
    }
    init();
  </script>
</body>
</html>
